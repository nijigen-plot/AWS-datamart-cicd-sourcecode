AWSTemplateFormatVersion: "2010-09-09"
Description: An example template for a Step Functions state machine.
Resources:
    # IAM Role
    StepFunctionServiceRole:
        Type: "AWS::IAM::Role"
        Properties:
            RoleName: DatamartUpdateRole
            AssumeRolePolicyDocument:
                Version: "2012-10-17"
                Statement:
                    - Effect: Allow
                      Principal:
                          Service:
                              - states.amazonaws.com
                              - scheduler.amazonaws.com
                              - lambda.amazonaws.com
                      Action: sts:AssumeRole
            ManagedPolicyArns: [arn:aws:iam::aws:policy/AdministratorAccess]
    # Lambda
    AthenaQueryScan:
        Type: "AWS::Lambda::Function"
        Properties:
            Code:
                S3Bucket: quark-cicd-test
                S3Key: lambda/src/athena-query-scan.zip
            FunctionName: athena-query-scan
            Handler: lambda_function.lambda_handler
            Role: !GetAtt StepFunctionServiceRole.Arn
            Runtime: python3.9
            Timeout: 60
    DeleteS3Objects:
        Type: "AWS::Lambda::Function"
        Properties:
            Code:
                S3Bucket: quark-cicd-test
                S3Key: lambda/src/delete-s3-objects.zip
            FunctionName: delete-s3-objects
            Handler: lambda_function.lambda_handler
            Role: !GetAtt StepFunctionServiceRole.Arn
            Runtime: python3.9
            Timeout: 60
    # StepFunctions
    StepFunctionStateMachine:
        Type: "AWS::StepFunctions::StateMachine"
        Properties:
            StateMachineName: AthenaQueryExecute
            StateMachineType: STANDARD
            DefinitionS3Location:
                Bucket: quark-cicd-test
                Key: stepfunctions/create_datamart.json
            RoleArn: !GetAtt StepFunctionServiceRole.Arn
        Metadata:
            "AWS::CloudFormation::Designer":
                id: 03217ee1-4cfd-4fee-804c-7a35f8901f6c
    # EventBridge Scheduler
    StepFunctionExecutionSchedule:
        Type: "AWS::Scheduler::Schedule"
        Properties:
            Description: AthenaQueryExecute StepFunction Daily Excecution
            ScheduleExpression: "cron(0 1 * * ? *)"
            FlexibleTimeWindow:
                Mode: FLEXIBLE
                MaximumWindowInMinutes: 15
            Name: AthenaQueryDailyExecution
            Target:
                Arn: !Ref StepFunctionStateMachine
                RoleArn: !GetAtt StepFunctionServiceRole.Arn
Metadata:
    "AWS::CloudFormation::Designer":
        03217ee1-4cfd-4fee-804c-7a35f8901f6c:
            size:
                width: 60
                height: 60
            position:
                x: 60
                "y": 90
            z: 1
            embeds: []
